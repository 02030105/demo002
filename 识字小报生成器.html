<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å„¿ç«¥è¯†å­—å°æŠ¥ç”Ÿæˆå™¨ - å®Œæ•´ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 18px;
            opacity: 0.95;
        }

        .main-content {
            padding: 40px;
        }

        .api-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .api-section h3 {
            color: #856404;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ff4d4f;
            transition: background-color 0.3s;
        }

        .status-indicator.active {
            background-color: #52c41a;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .form-group .help-text {
            margin-top: 8px;
            color: #666;
            font-size: 14px;
        }

        .form-group .help-text a {
            color: #667eea;
            text-decoration: none;
        }

        .form-group .help-text a:hover {
            text-decoration: underline;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102,126,234,0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: #52c41a;
            color: white;
        }

        .btn-success:hover {
            background: #73d13d;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .loading-container {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            display: none;
        }

        .result-container h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .result-image {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .message {
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .vocabulary-preview {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .vocabulary-preview h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .vocabulary-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .vocabulary-item {
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }

        .vocabulary-item .pinyin {
            color: #666;
            font-size: 12px;
        }

        .vocabulary-item .word {
            color: #333;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 28px;
            }

            .main-content {
                padding: 20px;
            }

            .api-section {
                padding: 20px;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ å„¿ç«¥è¯†å­—å°æŠ¥ç”Ÿæˆå™¨</h1>
            <p>ä¸“ä¸º5-9å²å„¿ç«¥è®¾è®¡çš„æ™ºèƒ½å­¦ä¹ ææ–™ç”Ÿæˆå·¥å…·</p>
        </div>

        <div class="main-content">
            <!-- APIå¯†é’¥é…ç½®åŒºåŸŸ -->
            <div class="api-section">
                <h3>ğŸ”‘ APIå¯†é’¥é…ç½®</h3>
                <div class="api-status">
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span id="statusText">æœªé…ç½®APIå¯†é’¥</span>
                </div>
                <div class="form-group">
                    <label for="apiKey">Nano Banana Pro API å¯†é’¥</label>
                    <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„APIå¯†é’¥">
                    <div class="help-text">è·å–å¯†é’¥åœ°å€: <a href="https://kie.ai/api-key" target="_blank">https://kie.ai/api-key</a></div>
                </div>
                <div class="message success" id="apiSuccessMessage"></div>
                <div class="message error" id="apiErrorMessage"></div>
            </div>

            <!-- ç”Ÿæˆé…ç½®åŒºåŸŸ -->
            <div class="form-group">
                <label for="scene">é€‰æ‹©åœºæ™¯</label>
                <select id="scene" onchange="updateVocabularyPreview()">
                    <option value="">è¯·é€‰æ‹©åœºæ™¯</option>
                    <option value="è¶…å¸‚">è¶…å¸‚</option>
                    <option value="åŒ»é™¢">åŒ»é™¢</option>
                    <option value="å…¬å›­">å…¬å›­</option>
                    <option value="å­¦æ ¡">å­¦æ ¡</option>
                    <option value="åŠ¨ç‰©å›­">åŠ¨ç‰©å›­</option>
                </select>
            </div>

            <div class="form-group">
                <label for="title">å°æŠ¥æ ‡é¢˜</label>
                <input type="text" id="title" placeholder="è¯·è¾“å…¥å°æŠ¥æ ‡é¢˜ï¼Œå¦‚ï¼šå¿«ä¹è¶…å¸‚ã€æœ‰è¶£çš„åŠ¨ç‰©å›­">
            </div>

            <!-- è¯æ±‡é¢„è§ˆ -->
            <div class="vocabulary-preview" id="vocabularyPreview" style="display: none;">
                <h4>ğŸ“š åœºæ™¯è¯æ±‡é¢„è§ˆ</h4>
                <div id="vocabularyList" class="vocabulary-list"></div>
            </div>

            <!-- ç”ŸæˆæŒ‰é’®ç»„ -->
            <div class="btn-group">
                <button class="btn btn-success" onclick="testApiKey()">
                    <span>ğŸ”</span> æµ‹è¯•è¿æ¥
                </button>
                <button class="btn btn-primary" id="generateBtn" onclick="generateImage()">
                    <span>âœ¨</span> ç”Ÿæˆå°æŠ¥
                </button>
                <button class="btn btn-secondary" onclick="clearAll()">
                    <span>ğŸ”„</span> æ¸…ç©ºé‡ç½®
                </button>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div class="loading-container" id="loadingContainer">
                <div class="spinner"></div>
                <p id="loadingText">æ­£åœ¨ç”Ÿæˆä¸­...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="loadingStatus">å‡†å¤‡ä¸­...</p>
                <p id="taskIdDisplay" style="font-size: 12px; color: #666; margin-top: 5px;"></p>
            </div>

            <!-- ç»“æœå±•ç¤º -->
            <div class="result-container" id="resultContainer">
                <h3>ğŸ‰ ç”ŸæˆæˆåŠŸï¼</h3>
                <img id="resultImage" class="result-image" alt="å„¿ç«¥è¯†å­—å°æŠ¥">
                <div class="btn-group">
                    <button class="btn btn-success" onclick="downloadImage()">
                        <span>ğŸ’¾</span> ä¿å­˜å›¾ç‰‡
                    </button>
                    <button class="btn btn-primary" onclick="resetForm()">
                        <span>ğŸ”„</span> é‡æ–°ç”Ÿæˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¯æ±‡åº“æ•°æ®
        const vocabularyData = {
            "è¶…å¸‚": {
                "characters": [
                    { word: "æ”¶é“¶å‘˜", pinyin: "shÅu yÃ­n yuÃ¡n" },
                    { word: "å¯¼è´­å‘˜", pinyin: "dÇo gÃ²u yuÃ¡n" },
                    { word: "é¡¾å®¢", pinyin: "gÃ¹ kÃ¨" },
                    { word: "ä¿å®‰", pinyin: "bÇo Än" },
                    { word: "ç†è´§å‘˜", pinyin: "lÇ huÃ² yuÃ¡n" }
                ],
                "items": [
                    { word: "è‹¹æœ", pinyin: "pÃ­ng guÇ’" },
                    { word: "ç‰›å¥¶", pinyin: "niÃº nÇi" },
                    { word: "é¢åŒ…", pinyin: "miÃ n bÄo" },
                    { word: "æ¨è½¦", pinyin: "tuÄ« chÄ“" },
                    { word: "è´­ç‰©ç¯®", pinyin: "gÃ²u wÃ¹ lÃ¡n" },
                    { word: "é¥¼å¹²", pinyin: "bÇng gÄn" },
                    { word: "é¸¡è›‹", pinyin: "jÄ« dÃ n" },
                    { word: "é¦™è•‰", pinyin: "xiÄng jiÄo" }
                ],
                "facilities": [
                    { word: "è´§æ¶", pinyin: "huÃ² jiÃ " },
                    { word: "æ”¶é“¶å°", pinyin: "shÅu yÃ­n tÃ¡i" },
                    { word: "å†·è—æŸœ", pinyin: "lÄ›ng cÃ¡ng guÃ¬" },
                    { word: "è´­ç‰©è¢‹", pinyin: "gÃ²u wÃ¹ dÃ i" },
                    { word: "ç”µæ¢¯", pinyin: "diÃ n tÄ«" }
                ],
                "environments": [
                    { word: "å…¥å£", pinyin: "rÃ¹ kÇ’u" },
                    { word: "å‡ºå£", pinyin: "chÅ« kÇ’u" },
                    { word: "æŒ‡ç¤ºç‰Œ", pinyin: "zhÇ shÃ¬ pÃ¡i" },
                    { word: "ç»ç’ƒé—¨", pinyin: "bÅ li mÃ©n" },
                    { word: "å®£ä¼ æµ·æŠ¥", pinyin: "xuÄn chuÃ¡n hÇi bÃ o" }
                ]
            },
            "åŒ»é™¢": {
                "characters": [
                    { word: "åŒ»ç”Ÿ", pinyin: "yÄ« shÄ“ng" },
                    { word: "æŠ¤å£«", pinyin: "hÃ¹ shi" },
                    { word: "ç—…äºº", pinyin: "bÃ¬ng rÃ©n" },
                    { word: "è¯å‰‚å¸ˆ", pinyin: "yÃ o jÃ¬ shÄ«" },
                    { word: "æ€¥æ•‘å‘˜", pinyin: "jÃ­ jiÃ¹ yuÃ¡n" }
                ],
                "items": [
                    { word: "å¬è¯Šå™¨", pinyin: "tÄ«ng zhÄ›n qÃ¬" },
                    { word: "ä½“æ¸©è®¡", pinyin: "tÇ wÄ“n jÃ¬" },
                    { word: "é’ˆç­’", pinyin: "zhÄ“n tÇ’ng" },
                    { word: "è¯ç‰‡", pinyin: "yÃ o piÃ n" },
                    { word: "çº±å¸ƒ", pinyin: "shÄ bÃ¹" },
                    { word: "å£ç½©", pinyin: "kÇ’u zhÃ o" },
                    { word: "ç—…å†æœ¬", pinyin: "bÃ¬ng lÃ¬ bÄ›n" },
                    { word: "æ‹æ–", pinyin: "guÇi zhÃ ng" }
                ],
                "facilities": [
                    { word: "ç—…åºŠ", pinyin: "bÃ¬ng chuÃ¡ng" },
                    { word: "è¾“æ¶²æ¶", pinyin: "shÅ« yÃ¨ jiÃ " },
                    { word: "è½®æ¤…", pinyin: "lÃºn yÇ" },
                    { word: "æ‰‹æœ¯å°", pinyin: "shÇ’u shÃ¹ tÃ¡i" },
                    { word: "è¯æˆ¿", pinyin: "yÃ o fÃ¡ng" }
                ],
                "environments": [
                    { word: "å€™è¯Šå®¤", pinyin: "hÃ²u zhÄ›n shÃ¬" },
                    { word: "æ€¥è¯Šå®¤", pinyin: "jÃ­ zhÄ›n shÃ¬" },
                    { word: "æ‰‹æœ¯å®¤", pinyin: "shÇ’u shÃ¹ shÃ¬" },
                    { word: "ç—…æˆ¿", pinyin: "bÃ¬ng fÃ¡ng" },
                    { word: "æŒ‚å·å¤„", pinyin: "guÃ  hÃ o chÃ¹" }
                ]
            },
            "å…¬å›­": {
                "characters": [
                    { word: "å°æœ‹å‹", pinyin: "xiÇo pÃ©ng yÇ’u" },
                    { word: "è€çˆ·çˆ·", pinyin: "lÇo yÃ© yÃ©" },
                    { word: "è€å¥¶å¥¶", pinyin: "lÇo nÇi nai" },
                    { word: "å›­ä¸", pinyin: "yuÃ¡n dÄ«ng" },
                    { word: "æ¸…æ´å·¥", pinyin: "qÄ«ng jiÃ© gÅng" }
                ],
                "items": [
                    { word: "é£ç­", pinyin: "fÄ“ng zheng" },
                    { word: "çš®çƒ", pinyin: "pÃ­ qiÃº" },
                    { word: "è‡ªè¡Œè½¦", pinyin: "zÃ¬ xÃ­ng chÄ“" },
                    { word: "å†°æ·‡æ·‹", pinyin: "bÄ«ng qÃ­ lÃ­n" },
                    { word: "æ°´å£¶", pinyin: "shuÇ hÃº" },
                    { word: "æŠ¥çº¸", pinyin: "bÃ o zhÇ" },
                    { word: "æ°”çƒ", pinyin: "qÃ¬ qiÃº" },
                    { word: "é‡é¤å«", pinyin: "yÄ› cÄn diÃ n" }
                ],
                "facilities": [
                    { word: "æ»‘æ¢¯", pinyin: "huÃ¡ tÄ«" },
                    { word: "ç§‹åƒ", pinyin: "qiÅ« qiÄn" },
                    { word: "é•¿æ¤…", pinyin: "chÃ¡ng yÇ" },
                    { word: "åƒåœ¾æ¡¶", pinyin: "lÄ jÄ« tÇ’ng" },
                    { word: "å‡‰äº­", pinyin: "liÃ¡ng tÃ­ng" }
                ],
                "environments": [
                    { word: "èŠ±æœµ", pinyin: "huÄ duÇ’" },
                    { word: "è‰åœ°", pinyin: "cÇo dÃ¬" },
                    { word: "æ ‘æœ¨", pinyin: "shÃ¹ mÃ¹" },
                    { word: "å°è·¯", pinyin: "xiÇo lÃ¹" },
                    { word: "æ± å¡˜", pinyin: "chÃ­ tÃ¡ng" }
                ]
            },
            "å­¦æ ¡": {
                "characters": [
                    { word: "è€å¸ˆ", pinyin: "lÇo shÄ«" },
                    { word: "å­¦ç”Ÿ", pinyin: "xuÃ© shÄ“ng" },
                    { word: "æ ¡é•¿", pinyin: "xiÃ o zhÇng" },
                    { word: "åŒå­¦", pinyin: "tÃ³ng xuÃ©" },
                    { word: "ç­é•¿", pinyin: "bÄn zhÇng" }
                ],
                "items": [
                    { word: "è¯¾æœ¬", pinyin: "kÃ¨ bÄ›n" },
                    { word: "é“…ç¬”", pinyin: "qiÄn bÇ" },
                    { word: "æ©¡çš®", pinyin: "xiÃ ng pÃ­" },
                    { word: "ä¹¦åŒ…", pinyin: "shÅ« bÄo" },
                    { word: "å°ºå­", pinyin: "chÇ zi" },
                    { word: "å½©ç¬”", pinyin: "cÇi bÇ" },
                    { word: "å¥–çŠ¶", pinyin: "jiÇng zhuÃ ng" },
                    { word: "åœ°çƒä»ª", pinyin: "dÃ¬ qiÃº yÃ­" }
                ],
                "facilities": [
                    { word: "é»‘æ¿", pinyin: "hÄ“i bÇn" },
                    { word: "è¯¾æ¡Œ", pinyin: "kÃ¨ zhuÅ" },
                    { word: "è®²å°", pinyin: "jiÇng tÃ¡i" },
                    { word: "æ“åœº", pinyin: "cÄo chÇng" },
                    { word: "å›¾ä¹¦é¦†", pinyin: "tÃº shÅ« guÇn" }
                ],
                "environments": [
                    { word: "æ•™å®¤", pinyin: "jiÃ o shÃ¬" },
                    { word: "èµ°å»Š", pinyin: "zÇ’u lÃ¡ng" },
                    { word: "æ ¡é—¨", pinyin: "xiÃ o mÃ©n" },
                    { word: "æ“åœº", pinyin: "cÄo chÇng" },
                    { word: "å®£ä¼ æ ", pinyin: "xuÄn chuÃ¡n lÃ¡n" }
                ]
            },
            "åŠ¨ç‰©å›­": {
                "characters": [
                    { word: "é¥²å…»å‘˜", pinyin: "sÃ¬ yÇng yuÃ¡n" },
                    { word: "æ¸¸å®¢", pinyin: "yÃ³u kÃ¨" },
                    { word: "å°æœ‹å‹", pinyin: "xiÇo pÃ©ng yÇ’u" },
                    { word: "è®²è§£å‘˜", pinyin: "jiÇng jiÄ› yuÃ¡n" },
                    { word: "æ‘„å½±å¸ˆ", pinyin: "shÃ¨ yÇng shÄ«" }
                ],
                "items": [
                    { word: "ç†ŠçŒ«", pinyin: "xiÃ³ng mÄo" },
                    { word: "å¤§è±¡", pinyin: "dÃ  xiÃ ng" },
                    { word: "é•¿é¢ˆé¹¿", pinyin: "chÃ¡ng jÇng lÃ¹" },
                    { word: "çŒ´å­", pinyin: "hÃ³u zi" },
                    { word: "è€è™", pinyin: "lÇo hÇ”" },
                    { word: "ç‹®å­", pinyin: "shÄ« zi" },
                    { word: "ä¼é¹…", pinyin: "qÇ Ã©" },
                    { word: "è¢‹é¼ ", pinyin: "dÃ i shÇ”" }
                ],
                "facilities": [
                    { word: "ç¬¼å­", pinyin: "lÃ³ng zi" },
                    { word: "è§‚æ™¯å°", pinyin: "guÄn jÇng tÃ¡i" },
                    { word: "ä¼‘æ¯åŒº", pinyin: "xiÅ« xi qÅ«" },
                    { word: "å”®ç¥¨å¤„", pinyin: "shÃ²u piÃ o chÃ¹" },
                    { word: "æŒ‡ç¤ºç‰Œ", pinyin: "zhÇ shÃ¬ pÃ¡i" }
                ],
                "environments": [
                    { word: "å‡å±±", pinyin: "jiÇ shÄn" },
                    { word: "æ°´æ± ", pinyin: "shuÇ chÃ­" },
                    { word: "æ ‘æœ¨", pinyin: "shÃ¹ mÃ¹" },
                    { word: "è‰åª", pinyin: "cÇo pÃ­ng" },
                    { word: "å°è·¯", pinyin: "xiÇo lÃ¹" }
                ]
            }
        };

        // APIé…ç½®
        const API_BASE_URL = 'https://api.kie.ai/api/v1/jobs';
        let currentApiKey = null;
        let currentTaskId = null;
        let pollInterval = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            // ä»localStorageæ¢å¤APIå¯†é’¥
            const savedApiKey = localStorage.getItem('nano_api_key');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
                updateApiKeyStatus(true);
            }
        });

        // æ›´æ–°APIå¯†é’¥çŠ¶æ€
        function updateApiKeyStatus(hasKey) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            if (hasKey) {
                indicator.classList.add('active');
                statusText.textContent = 'APIå¯†é’¥å·²é…ç½®';
            } else {
                indicator.classList.remove('active');
                statusText.textContent = 'æœªé…ç½®APIå¯†é’¥';
            }
        }

        // ç›‘å¬APIå¯†é’¥è¾“å…¥
        document.getElementById('apiKey').addEventListener('input', (e) => {
            const apiKey = e.target.value.trim();
            if (apiKey) {
                localStorage.setItem('nano_api_key', apiKey);
                currentApiKey = apiKey;
                updateApiKeyStatus(true);
            } else {
                localStorage.removeItem('nano_api_key');
                currentApiKey = null;
                updateApiKeyStatus(false);
            }
        });

        // æµ‹è¯•APIè¿æ¥
        async function testApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!apiKey) {
                showMessage('apiErrorMessage', 'è¯·å…ˆè¾“å…¥APIå¯†é’¥');
                return;
            }

            try {
                // åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•ä»»åŠ¡
                const response = await fetch(`${API_BASE_URL}/createTask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'nano-banana-pro',
                        input: {
                            prompt: 'test',
                            aspect_ratio: '1:1',
                            resolution: '1K',
                            output_format: 'png'
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.code === 200) {
                        showMessage('apiSuccessMessage', 'APIå¯†é’¥éªŒè¯æˆåŠŸï¼');
                        updateApiKeyStatus(true);
                    } else {
                        showMessage('apiErrorMessage', `APIé”™è¯¯: ${data.msg}`);
                    }
                } else if (response.status === 401) {
                    showMessage('apiErrorMessage', 'APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥');
                } else if (response.status === 402) {
                    showMessage('apiErrorMessage', 'è´¦æˆ·ä½™é¢ä¸è¶³ï¼Œè¯·å……å€¼');
                } else {
                    showMessage('apiErrorMessage', `è¿æ¥å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                showMessage('apiErrorMessage', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // ç”Ÿæˆæç¤ºè¯
        function generatePrompt(scene, title) {
            const vocab = vocabularyData[scene];

            const formatVocabList = (list, limit = 5) => {
                return list.slice(0, limit)
                    .map(item => `${item.pinyin} ${item.word}`)
                    .join(', ');
            };

            return `è¯·ç”Ÿæˆä¸€å¼ å„¿ç«¥è¯†å­—å°æŠ¥ã€Š${scene}ã€‹ï¼Œç«–ç‰ˆ A4ï¼Œå­¦ä¹ å°æŠ¥ç‰ˆå¼ï¼Œé€‚åˆ 5â€“9 å²å­©å­ è®¤å­—ä¸çœ‹å›¾è¯†ç‰©ã€‚

# ä¸€ã€å°æŠ¥æ ‡é¢˜åŒºï¼ˆé¡¶éƒ¨ï¼‰

**é¡¶éƒ¨å±…ä¸­å¤§æ ‡é¢˜**ï¼šã€Š${title}ã€‹
* **é£æ ¼**ï¼šåå­—å°æŠ¥ / å„¿ç«¥å­¦ä¹ æŠ¥æ„Ÿ
* **æ–‡æœ¬è¦æ±‚**ï¼šå¤§å­—ã€é†’ç›®ã€å¡é€šæ‰‹å†™ä½“ã€å½©è‰²æè¾¹
* **è£…é¥°**ï¼šå‘¨å›´æ·»åŠ ä¸ ${scene} ç›¸å…³çš„è´´çº¸é£è£…é¥°ï¼Œé¢œè‰²é²œè‰³

# äºŒã€å°æŠ¥ä¸»ä½“ï¼ˆä¸­é—´ä¸»ç”»é¢ï¼‰

ç”»é¢ä¸­å¿ƒæ˜¯ä¸€å¹… **å¡é€šæ’ç”»é£çš„ã€Œ${scene}ã€åœºæ™¯**ï¼š
* **æ•´ä½“æ°”æ°›**ï¼šæ˜äº®ã€æ¸©æš–ã€ç§¯æ
* **æ„å›¾**ï¼šç‰©ä½“è¾¹ç•Œæ¸…æ™°ï¼Œæ–¹ä¾¿å¯¹åº”æ–‡å­—ï¼Œä¸è¦è¿‡äºæ‹¥æŒ¤ã€‚

**åœºæ™¯åˆ†åŒºä¸æ ¸å¿ƒå†…å®¹**
1.  **æ ¸å¿ƒåŒºåŸŸ Aï¼ˆä¸»è¦å¯¹è±¡ï¼‰**ï¼šè¡¨ç° ${scene} çš„æ ¸å¿ƒæ´»åŠ¨ã€‚
2.  **æ ¸å¿ƒåŒºåŸŸ Bï¼ˆé…å¥—è®¾æ–½ï¼‰**ï¼šå±•ç¤ºç›¸å…³çš„å·¥å…·æˆ–ç‰©å“ã€‚
3.  **æ ¸å¿ƒåŒºåŸŸ Cï¼ˆç¯å¢ƒèƒŒæ™¯ï¼‰**ï¼šä½“ç°ç¯å¢ƒç‰¹å¾ï¼ˆå¦‚å¢™é¢ã€æŒ‡ç¤ºç‰Œç­‰ï¼‰ã€‚

**ä¸»é¢˜äººç‰©**
* **è§’è‰²**ï¼š1 ä½å¯çˆ±å¡é€šäººç‰©ï¼ˆèŒä¸š/èº«ä»½ï¼šä¸ ${scene} åŒ¹é…ï¼‰ã€‚
* **åŠ¨ä½œ**ï¼šæ­£åœ¨è¿›è¡Œä¸åœºæ™¯ç›¸å…³çš„è‡ªç„¶äº’åŠ¨ã€‚

# ä¸‰ã€å¿…ç”»ç‰©ä½“ä¸è¯†å­—æ¸…å•ï¼ˆGenerated Contentï¼‰

**è¯·åŠ¡å¿…åœ¨ç”»é¢ä¸­æ¸…æ™°ç»˜åˆ¶ä»¥ä¸‹ç‰©ä½“ï¼Œå¹¶ä¸ºå…¶é¢„ç•™è´´æ ‡ç­¾çš„ä½ç½®ï¼š**

**1. æ ¸å¿ƒè§’è‰²ä¸è®¾æ–½ï¼š**
${formatVocabList([...vocab.characters, ...vocab.facilities])}

**2. å¸¸è§ç‰©å“/å·¥å…·ï¼š**
${formatVocabList(vocab.items, 8)}

**3. ç¯å¢ƒä¸è£…é¥°ï¼š**
${formatVocabList(vocab.environments)}

*(æ³¨æ„ï¼šç”»é¢ä¸­çš„ç‰©ä½“æ•°é‡ä¸é™äºæ­¤ï¼Œä½†ä»¥ä¸Šåˆ—è¡¨å¿…é¡»ä½œä¸ºé‡ç‚¹æç»˜å¯¹è±¡)*

# å››ã€è¯†å­—æ ‡æ³¨è§„åˆ™

å¯¹ä¸Šè¿°æ¸…å•ä¸­çš„ç‰©ä½“ï¼Œè´´ä¸Šä¸­æ–‡è¯†å­—æ ‡ç­¾ï¼š
* **æ ¼å¼**ï¼šä¸¤è¡Œåˆ¶ï¼ˆç¬¬ä¸€è¡Œæ‹¼éŸ³å¸¦å£°è°ƒï¼Œç¬¬äºŒè¡Œç®€ä½“æ±‰å­—ï¼‰ã€‚
* **æ ·å¼**ï¼šå½©è‰²å°è´´çº¸é£æ ¼ï¼Œç™½åº•é»‘å­—æˆ–æ·±è‰²å­—ï¼Œæ¸…æ™°å¯è¯»ã€‚
* **æ’ç‰ˆ**ï¼šæ ‡ç­¾é è¿‘å¯¹åº”çš„ç‰©ä½“ï¼Œä¸é®æŒ¡ä¸»ä½“ã€‚

# äº”ã€ç”»é£å‚æ•°
* **é£æ ¼**ï¼šå„¿ç«¥ç»˜æœ¬é£ + è¯†å­—å°æŠ¥é£
* **è‰²å½©**ï¼šé«˜é¥±å’Œã€æ˜å¿«ã€æ¸©æš– (High Saturation, Warm Tone)
* **è´¨é‡**ï¼š8k resolution, high detail, vector illustration style, clean lines.`;
        }

        // ç”Ÿæˆå›¾ç‰‡
        async function generateImage() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const scene = document.getElementById('scene').value;
            const title = document.getElementById('title').value.trim();

            // éªŒè¯è¾“å…¥
            if (!apiKey) {
                showMessage('apiErrorMessage', 'è¯·å…ˆè¾“å…¥APIå¯†é’¥');
                return;
            }

            if (!scene) {
                showMessage('apiErrorMessage', 'è¯·é€‰æ‹©ä¸€ä¸ªåœºæ™¯');
                return;
            }

            if (!title) {
                showMessage('apiErrorMessage', 'è¯·è¾“å…¥å°æŠ¥æ ‡é¢˜');
                return;
            }

            // ç”Ÿæˆæç¤ºè¯
            const prompt = generatePrompt(scene, title);
            currentApiKey = apiKey;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading();

            try {
                // åˆ›å»ºä»»åŠ¡
                const response = await fetch(`${API_BASE_URL}/createTask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'nano-banana-pro',
                        input: {
                            prompt: prompt,
                            image_input: [],
                            aspect_ratio: '3:4',
                            resolution: '2K',
                            output_format: 'png'
                        }
                    })
                });

                const data = await response.json();
                console.log('åˆ›å»ºä»»åŠ¡çš„å“åº”:', data);

                if (data.code === 200) {
                    currentTaskId = data.data.taskId;
                    console.log('ä»»åŠ¡IDå·²ä¿å­˜:', currentTaskId);
                    updateProgress(20);
                    updateLoadingStatus('ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œæ­£åœ¨ç”Ÿæˆ...');
                    document.getElementById('taskIdDisplay').textContent = `ä»»åŠ¡ID: ${currentTaskId}`;

                    // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                    startPolling();
                } else {
                    console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥:', data);
                    throw new Error(data.msg || 'åˆ›å»ºä»»åŠ¡å¤±è´¥');
                }
            } catch (error) {
                hideLoading();
                showMessage('apiErrorMessage', `ç”Ÿæˆå¤±è´¥: ${error.message}`);
            }
        }

        // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
        function startPolling() {
            let retryCount = 0;
            const maxRetries = 30;

            console.log('å¼€å§‹è½®è¯¢ä»»åŠ¡ID:', currentTaskId);
            updateLoadingStatus('ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œæ­£åœ¨è½®è¯¢ç»“æœ...');

            pollInterval = setInterval(async () => {
                try {
                    console.log(`è½®è¯¢ç¬¬ ${retryCount + 1} æ¬¡...`);
                    const response = await fetch(`${API_BASE_URL}/recordInfo?taskId=${currentTaskId}`, {
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`
                    }
                });

                    console.log('å“åº”çŠ¶æ€:', response.status);
                    const data = await response.json();

                    console.log('å“åº”æ•°æ®:', data);

                    if (data.code === 200) {
                        const state = data.data.state;
                        console.log('ä»»åŠ¡çŠ¶æ€:', state);
                        console.log('å®Œæ•´æ•°æ®:', JSON.stringify(data.data, null, 2));

                        if (state === 'success') {
                            console.log('ä»»åŠ¡æˆåŠŸï¼');
                            updateProgress(100);

                            try {
                                const resultJson = JSON.parse(data.data.resultJson);
                                console.log('è§£æçš„ç»“æœ:', resultJson);

                                if (resultJson && resultJson.resultUrls && resultJson.resultUrls.length > 0) {
                                    const imageUrl = resultJson.resultUrls[0];
                                    console.log('å›¾ç‰‡URL:', imageUrl);
                                    updateLoadingStatus('å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼Œæ­£åœ¨åŠ è½½...');
                                    showResult(imageUrl);
                                    clearInterval(pollInterval);
                                } else {
                                    console.error('ç»“æœä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡URL');
                                    throw new Error('ç”Ÿæˆçš„ç»“æœä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡URL');
                                }
                            } catch (parseError) {
                                console.error('è§£æç»“æœJSONå¤±è´¥:', parseError);
                                console.log('åŸå§‹resultJson:', data.data.resultJson);
                                throw new Error('è§£æç”Ÿæˆç»“æœå¤±è´¥');
                            }
                        } else if (state === 'fail') {
                            console.error('ä»»åŠ¡å¤±è´¥:', data.data.failMsg);
                            throw new Error(data.data.failMsg || 'ç”Ÿæˆå¤±è´¥');
                        } else {
                            // æ›´æ–°è¿›åº¦
                            retryCount++;
                            const progress = Math.min(20 + (retryCount * 2), 90);
                            updateProgress(progress);
                            updateLoadingStatus(`ç”Ÿæˆä¸­... çŠ¶æ€: ${state} (${retryCount}/${maxRetries})`);
                        }
                    } else {
                        console.error('APIè¿”å›é”™è¯¯:', data);
                        retryCount++;
                        updateLoadingStatus(`APIé”™è¯¯ï¼Œé‡è¯•ä¸­... (${retryCount}/${maxRetries})`);
                    }
                } catch (error) {
                    console.error('è½®è¯¢å‡ºé”™:', error);
                    clearInterval(pollInterval);
                    hideLoading();
                    showMessage('apiErrorMessage', `æŸ¥è¯¢å¤±è´¥: ${error.message}`);
                }

                if (retryCount >= maxRetries) {
                    clearInterval(pollInterval);
                    hideLoading();
                    showMessage('apiErrorMessage', 'ä»»åŠ¡è¶…æ—¶ï¼Œè¯·é‡è¯•');
                }
            }, 3000);
        }

        // æ›´æ–°è¯æ±‡é¢„è§ˆ
        function updateVocabularyPreview() {
            const scene = document.getElementById('scene').value;
            const preview = document.getElementById('vocabularyPreview');
            const list = document.getElementById('vocabularyList');

            if (!scene || !vocabularyData[scene]) {
                preview.style.display = 'none';
                return;
            }

            const vocab = vocabularyData[scene];
            let html = '';

            const allWords = [
                ...vocab.characters,
                ...vocab.items,
                ...vocab.facilities,
                ...vocab.environments
            ];

            allWords.forEach(item => {
                html += `
                    <div class="vocabulary-item">
                        <div class="pinyin">${item.pinyin}</div>
                        <div class="word">${item.word}</div>
                    </div>
                `;
            });

            list.innerHTML = html;
            preview.style.display = 'block';
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loadingContainer').style.display = 'block';
            document.getElementById('resultContainer').style.display = 'none';
            updateProgress(10);
            updateLoadingStatus('å‡†å¤‡ä¸­...');
        }

        function hideLoading() {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('taskIdDisplay').textContent = '';
            clearInterval(pollInterval);
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        function updateLoadingStatus(text) {
            document.getElementById('loadingStatus').textContent = text;
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(imageUrl) {
            hideLoading();
            const resultImage = document.getElementById('resultImage');

            // æ·»åŠ å›¾ç‰‡åŠ è½½äº‹ä»¶ç›‘å¬
            resultImage.onload = function() {
                document.getElementById('resultContainer').style.display = 'block';
                // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                document.getElementById('resultContainer').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            };

            resultImage.onerror = function() {
                console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', imageUrl);
                // å°è¯•é€šè¿‡ä»£ç†åŠ è½½å›¾ç‰‡
                loadImageThroughProxy(imageUrl);
            };

            // è®¾ç½®å›¾ç‰‡æº
            resultImage.src = imageUrl;
        }

        // é€šè¿‡ä»£ç†åŠ è½½å›¾ç‰‡
        async function loadImageThroughProxy(imageUrl) {
            try {
                // åˆ›å»ºä¸€ä¸ªcanvasæ¥ä»£ç†åŠ è½½å›¾ç‰‡
                const img = new Image();
                img.crossOrigin = 'anonymous';

                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    // è½¬æ¢ä¸ºblobå¹¶æ˜¾ç¤º
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const resultImage = document.getElementById('resultImage');
                        resultImage.src = url;
                        resultImage.onload = function() {
                            URL.revokeObjectURL(url);
                            document.getElementById('resultContainer').style.display = 'block';
                            document.getElementById('resultContainer').scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        };
                    }, 'image/png');
                };

                img.onerror = function() {
                    // å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œæ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆ
                    showImageFallback(imageUrl);
                };

                // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                img.src = imageUrl + (imageUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
            } catch (error) {
                console.error('ä»£ç†åŠ è½½å¤±è´¥:', error);
                showImageFallback(imageUrl);
            }
        }

        // æ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆ
        function showImageFallback(imageUrl) {
            const resultContainer = document.getElementById('resultContainer');
            const resultImage = document.getElementById('resultImage');

            // åˆ›å»ºä¸€ä¸ªåŒ…å«å›¾ç‰‡é“¾æ¥çš„å®¹å™¨
            const fallbackDiv = document.createElement('div');
            fallbackDiv.style.padding = '20px';
            fallbackDiv.style.background = '#f8f9fa';
            fallbackDiv.style.borderRadius = '8px';
            fallbackDiv.style.textAlign = 'center';

            fallbackDiv.innerHTML = `
                <p style="margin-bottom: 15px; color: #666;">å›¾ç‰‡æ— æ³•ç›´æ¥æ˜¾ç¤ºï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹ï¼š</p>
                <a href="${imageUrl}" target="_blank" style="display: inline-block; padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; margin-bottom: 10px;">
                    åœ¨æ–°çª—å£æ‰“å¼€å›¾ç‰‡
                </a>
                <br>
                <button onclick="downloadImageFromUrl('${imageUrl}')" style="padding: 10px 20px; background: #52c41a; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    ä¸‹è½½å›¾ç‰‡
                </button>
                <p style="margin-top: 15px; font-size: 12px; color: #999;">å›¾ç‰‡é“¾æ¥: <span style="word-break: break-all;">${imageUrl}</span></p>
            `;

            // éšè—åŸå§‹å›¾ç‰‡ï¼Œæ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆ
            resultImage.style.display = 'none';
            resultContainer.appendChild(fallbackDiv);
            resultContainer.style.display = 'block';
            resultContainer.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        // ä¸‹è½½å›¾ç‰‡
        async function downloadImage() {
            const imageUrl = document.getElementById('resultImage').src;
            const title = document.getElementById('title').value.trim() || 'è¯†å­—å°æŠ¥';

            // å¦‚æœå›¾ç‰‡æ˜¯blob URLï¼Œä¸èƒ½ç›´æ¥ä¸‹è½½
            if (imageUrl.startsWith('blob:')) {
                showMessage('apiErrorMessage', 'è¯·ä½¿ç”¨ä¸‹æ–¹æŒ‰é’®ä¸‹è½½å›¾ç‰‡');
                return;
            }

            await downloadImageFromUrl(imageUrl, title);
        }

        // ä»URLä¸‹è½½å›¾ç‰‡
        async function downloadImageFromUrl(imageUrl, title = null) {
            if (!title) {
                title = document.getElementById('title').value.trim() || 'è¯†å­—å°æŠ¥';
            }

            try {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const a = document.createElement('a');
                a.href = imageUrl;
                a.download = `${title}.png`;
                a.target = '_blank';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                showMessage('apiSuccessMessage', 'å›¾ç‰‡ä¸‹è½½å·²å¼€å§‹ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨ä¸‹è½½åˆ—è¡¨');
            } catch (error) {
                showMessage('apiErrorMessage', 'ä¸‹è½½å¤±è´¥ï¼Œè¯·å³é”®å›¾ç‰‡å¦å­˜ä¸º');
            }
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('scene').value = '';
            document.getElementById('title').value = '';
            document.getElementById('vocabularyPreview').style.display = 'none';

            // æ¸…ç†ç»“æœå®¹å™¨
            const resultContainer = document.getElementById('resultContainer');
            const resultImage = document.getElementById('resultImage');

            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„fallback div
            const existingFallback = resultContainer.querySelector('div[style*="padding: 20px"]');
            if (existingFallback) {
                existingFallback.remove();
            }

            // é‡ç½®å›¾ç‰‡æ˜¾ç¤º
            resultImage.style.display = 'block';
            resultImage.src = '';

            resultContainer.style.display = 'none';
            hideLoading();
            clearMessages();
        }

        // æ¸…ç©ºæ‰€æœ‰
        function clearAll() {
            resetForm();
            document.getElementById('apiKey').value = '';
            localStorage.removeItem('nano_api_key');
            currentApiKey = null;
            updateApiKeyStatus(false);
            clearMessages();
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, message) {
            clearMessages();
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';

            // è‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (elementId === 'apiSuccessMessage') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 3000);
            }
        }

        // æ¸…é™¤æ‰€æœ‰æ¶ˆæ¯
        function clearMessages() {
            document.getElementById('apiSuccessMessage').style.display = 'none';
            document.getElementById('apiErrorMessage').style.display = 'none';
        }

        // å¯¼å‡ºå‡½æ•°ä¾›HTMLè°ƒç”¨
        window.testApiKey = testApiKey;
        window.generateImage = generateImage;
        window.downloadImage = downloadImage;
        window.downloadImageFromUrl = downloadImageFromUrl;
        window.resetForm = resetForm;
        window.clearAll = clearAll;
    </script>
</body>
</html>